<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Welcome to Our Hospital, a leading healthcare
    provider offering comprehensive healthcare services including emergency care,
    pediatric care, cardiology, orthopedics, maternity care, neurology, oncology,
    and mental health services. Experience our state-of-the-art virtual doctor 
    service for online consultations. Our team of expert doctors and nurses are 
    dedicated to providing the highest quality of care. Book your appointment today 
    for top-notch medical services.">
    <title>Virtual Doctor | telemedicine | health | hospital</title>
    <link rel="icon" type="image/jpeg" href="{{url_for('static', filename='images/logo.jpeg')}}">
    <link rel="stylesheet" type="text/css" href="{{url_for('static', filename='hosp_styles.css')}}">
    <link rel="stylesheet" type="text/css" href="{{url_for('static', filename='styles.css')}}">
</head>
<body>
<!-- Navigation Bar -->
<div class="phone">
<a href="{{url_for('public.home')}}">
<img src="{{url_for('static', filename='images/logo.jpeg')}}" alt="logo" id="phone_logo">
</a>
<p><i><strong>"Your health matters to us"</strong></i></p>
</div>
<br>
<a href="{{url_for('user.pharm_orders', page=back)}}">
    <button>Back</button>
</a>

    <!--flash message-->
<div class="container">
    <br>
  
    {% with flash_msg = get_flashed_messages() %}
       {% if flash_msg %}
            {% for message in flash_msg %}
                <h4> {{ message }} </h4>
            {% endfor %}
        {% endif %}
    {% endwith %}
   
</div>

    <button onclick="toggle_form()">Upload prescription</button>
    <!--toggle form visibility-->
    {%if step1%}
    <div class="form-container">
    <form action="{{url_for('user.pharm_search')}}" method="post" id="consultation-form">
        <h2>Please fill in the form with your prescription</h2>
        <div id="prescription-entries"></div>
        <button type="submit" class="submit-button">Submit</button>
    </form>
    </div>
    {%endif%}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        let prescriptionCounter = 1; // initial number of prescription entries

        function addPrescriptionEntry() {
            const container = document.getElementById('prescription-entries');
            const newEntry = document.createElement('div');
            newEntry.className = 'entry';
            newEntry.innerHTML = `
                <input type="text" name="med_name${prescriptionCounter}" placeholder="Medicine Name">
                <input type="text" name="dosage${prescriptionCounter}" placeholder="Dosage">
            `;
            container.appendChild(newEntry);
            prescriptionCounter++;
            attachInputListeners(newEntry);
        }

        function attachInputListeners(entry) {
            const inputs = entry.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('input', handleInput);
            });
        }

        function handleInput(event) {
            const entry = event.target.closest('.entry');
            if (isEntryFilled(entry) && isLastEntry(entry)) {
                addPrescriptionEntry();
            }
        }

        function isEntryFilled(entry) {
            const inputs = entry.querySelectorAll('input');
            return Array.from(inputs).every(input => input.value !== '');
        }

        function isLastEntry(entry) {
            const entries = document.querySelectorAll('#prescription-entries .entry');
            return entry === entries[entries.length - 1];
        }

        function initializeEntries() {
            for (let i = 1; i <= 3; i++) {
                addPrescriptionEntry();
            }
        }

        initializeEntries();

        document.getElementById('consultation-form').addEventListener('submit', function(event) {
            const entries = document.querySelectorAll('#prescription-entries .entry');
            if (!validateEntries(entries)) {
                event.preventDefault();
                alert('Please fill all fields in the started entries.');
            }
        });

        function validateEntries(entries) {
            let allValid = true;
            entries.forEach(entry => {
                if (isEntryStarted(entry) && !isEntryFilled(entry)) {
                    allValid = false;
                    highlightEmptyFields(entry);
                }
            });
            return allValid;
        }

        function isEntryStarted(entry) {
            const inputs = entry.querySelectorAll('input');
            return Array.from(inputs).some(input => input.value !== '');
        }

        function highlightEmptyFields(entry) {
            const inputs = entry.querySelectorAll('input');
            inputs.forEach(input => {
                if (input.value === '') {
                    input.classList.add('highlight');
                } else {
                    input.classList.remove('highlight');
                }
            });
        }
    });
</script>
{%if step2%}
<!--display prescription being searched-->
{% if med_entries %}
    <h2>
        prescription being searched
    </h2>
    {%for med in med_entries%}
        <div>
            <p>Medicine: {{med['med_name']}}</p>
        </div>
    {%endfor%}
{%endif%}
<!--Display medicine not found-->
{%if not_av%}
    {%for med in not_av%}
        <div>
            <p>Medicine: {{med}}</p>
        </div>
    {%endfor%}
{%endif%}
<!--display search results-->
{% if av_pharm %}
    <h2>
        Results for the above prescription
    </h2>
    {% for pharm in av_pharm %}
        <div>
            <p>Pharmacy: {{pharm.name}}</p>
            <p>Total cost: {{pharm.price}}</p>
            <form action="{{url_for('user.pharm_orders')}}" method="post">
                <input type="hidden" name="pharm_uuid" value="{{pharm.pharm_uuid}}">
                <input type="hidden" name="price" value="{{pharm.price}}">
                <input type="hidden" name="lat" id="lat">
                <input type="hidden" name="long" id="long">
                <button type="button" class="make_order_btn" onclick="getLocation()">Get location before submiting the order</button>
                <input type="submit" value="Make order">
            </form>
        </div>
    {%endfor%}
{%else%}
    <h2>No results found!</h2>
{%endif%}
{%endif%}

{%if step3%}
    <h2>Order was placed successfully. The pharmacy will be in contact with you shortly regarding delivery</h2>
{%endif%}

<script>

//get location
function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;

            // Populate the hidden form fields
            document.getElementById('lat').value = latitude;
            document.getElementById('long').value = longitude;
        });
    }
}
</script>

{% extends "/public/base.html" %}